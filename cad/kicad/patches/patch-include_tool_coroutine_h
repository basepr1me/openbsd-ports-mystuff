$OpenBSD$

Index: include/tool/coroutine.h
--- include/tool/coroutine.h.orig
+++ include/tool/coroutine.h
@@ -49,6 +49,8 @@
 #include <trace_helpers.h>
 #include <wx/log.h>
 
+#include <sys/mman.h>
+
 /**
  *  Implement a coroutine.
  *
@@ -172,6 +174,8 @@ class COROUTINE (public)
     COROUTINE() :
         COROUTINE( nullptr )
     {
+        if (m_stack)
+            munmap(m_stack.release(), m_stacksize);
     }
 
     /**
@@ -377,7 +381,10 @@ class COROUTINE (public)
 #ifndef LIBCONTEXT_HAS_OWN_STACK
 
         // fixme: Clean up stack stuff. Add a guard
-        m_stack.reset( new char[stackSize] );
+	void *p = mmap(NULL, stackSize, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANON | MAP_STACK, -1, 0);
+	if (p == MAP_FAILED)
+            throw std::bad_alloc();
+        m_stack.reset( static_cast<char *>(p) );
 
         // align to 16 bytes
         sp = (void*)((((ptrdiff_t) m_stack.get()) + stackSize - 0xf) & (~0x0f));
